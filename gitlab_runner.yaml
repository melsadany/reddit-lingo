---
Description: CloudFormation template for creating a Lingo GitLab Runner
Parameters:
  KeyName:
    Description: Key Pair name
    Type: AWS::EC2::KeyPair::KeyName
    Default: xxx-xxx
  VPC:
    Type: AWS::EC2::VPC::Id
    Default: givevpcid
  Subnet:
    Type: AWS::EC2::Subnet::Id
    Default: givesubnetid
  InstanceType:
    Description: Select one of the possible instance types
    Type: String
    Default: t2.medium
  SecurityGroup:
    Type: AWS::EC2::SecurityGroup::Id
    Default: givesecuritygroupid
  ImageID:
    Type: AWS::EC2::Image::Id
    Default: ami-0de53d8956e8dcf80
  GitLabUrl:
    Type: String
    Default: https://research-git.uiowa.edu/
  GitLabRegistrationToken:
    Type: String
    Default: GitLab Runner Registration Token
Resources:
  IamInstanceProfileForRunner:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - ec2tos3
      InstanceProfileName: RunnerInstanceProfile
  RunnerServer:
    Type: AWS::EC2::Instance
    Properties:
      IamInstanceProfile:
        Ref:
          IamInstanceProfileForRunner
      ImageId:
        Ref: ImageID
      InstanceType:
        Ref: InstanceType
      KeyName:
        Ref: KeyName
      SecurityGroupIds:
      - Ref: SecurityGroup
      SubnetId:
        Ref: Subnet
      Tags:
      - Key: Name
        Value: LingoGitlabRunner
      UserData:
        Fn::Base64:
          Fn::Sub: |
            #!/bin/bash -xe
             sudo yum update -y
             sudo amazon-linux-extras install docker -y
             sudo service docker start
             curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.rpm.sh | sudo bash
             sudo yum install gitlab-runner -y
             sudo gitlab-runner register \
                --non-interactive \
                --url ${GitLabUrl} \
                --registration-token ${GitLabRegistrationToken} \
                --executor "docker" \
                --docker-image "node:10.15.3-alpine" \
                --description "Lingo Runner" \
                --tag-list "" \
                --run-untagged="true" \
Outputs:
  PublicName:
    Value:
      Fn::GetAtt:
      - RunnerServer
      - PublicDnsName
    Description: Public name (connect via SSH)
